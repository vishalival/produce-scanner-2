<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Produce Freshness Scanner</title>
    <style>
        :root {
            --cream: #f9f1e4;
            --soft-yellow: #ffe3b3;
            --card: #fff9ef;
            --text-dark: #181512;
            --text-muted: #7a6f63;
            --accent: #ff9f66;
            --border: rgba(0, 0, 0, 0.08);
            --nav-bg: #fff5e3;
            --discount-green: #41c17c;
            --discount-light: #92d997;
            --discount-orange: #ffa756;
            --discount-red: #f26d6d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--cream);
            color: var(--text-dark);
            min-height: 100vh;
            letter-spacing: -0.2px;
        }

        #root {
            min-height: 100vh;
        }

        .app-shell {
            max-width: 520px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--cream);
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 32px 20px 10px;
            text-align: center;
        }

        header h1 {
            font-size: 28px;
            font-weight: 800;
            line-height: 1.1;
        }

        header span {
            font-size: 14px;
            color: var(--text-muted);
            letter-spacing: 2.5px;
            text-transform: uppercase;
        }

        .page-content {
            flex: 1;
            padding: 0 20px 120px;
        }

        .panel {
            background: var(--card);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 20px 45px rgba(215, 185, 147, 0.35);
            border: 1px solid var(--border);
        }

        .grid {
            display: grid;
            gap: 16px;
        }

        label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 4px;
            display: block;
        }

        select,
        input {
            width: 100%;
            border-radius: 16px;
            border: 2px solid transparent;
            background: white;
            padding: 14px 16px;
            font-size: 16px;
            font-weight: 600;
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.04);
            transition: border 0.2s ease, transform 0.2s ease;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: #ffd38a;
            transform: translateY(-1px);
        }

        .camera-card {
            position: relative;
            background: white;
            border-radius: 28px;
            padding: 18px;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border: 1px solid var(--border);
        }

        .camera-preview {
            flex: 1;
            border-radius: 22px;
            background: #d2c5b6;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 16px;
        }

        .circle-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            background: #1f1c17;
            color: white;
            font-size: 28px;
            display: grid;
            place-items: center;
            cursor: pointer;
        }

        .secondary-btn {
            border-radius: 50%;
            width: 52px;
            height: 52px;
            border: 1px dashed #c1b5ab;
            background: transparent;
            font-size: 22px;
            color: #7f736a;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .primary-btn,
        .ghost-btn {
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 8px;
        }

        .primary-btn {
            background: #1f1c17;
            color: white;
        }

        .ghost-btn {
            background: transparent;
            border: 1px solid #d9cbbf;
            color: #3b332c;
        }

        .primary-btn:active,
        .ghost-btn:active {
            transform: translateY(1px);
        }

        .analysis-grid {
            display: grid;
            gap: 14px;
            margin-top: 18px;
        }

        .analysis-card {
            border-radius: 18px;
            padding: 16px;
            background: white;
            border: 1px solid var(--border);
        }

        .analysis-card h3 {
            font-size: 16px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stars {
            color: #f4b73f;
            font-size: 20px;
        }

        .badge {
            align-self: flex-start;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 700;
            color: #1f1c17;
        }

        .badge.green { background: #d8f5e7; color: #097c44; }
        .badge.light { background: #e5f7dd; color: #437841; }
        .badge.orange { background: #ffe2cc; color: #9b5103; }
        .badge.red { background: #ffe5e5; color: #a42020; }

        .result-hero {
            background: white;
            border-radius: 32px;
            padding: 24px;
            display: grid;
            gap: 14px;
            border: 1px solid var(--border);
        }

        .result-image {
            border-radius: 28px;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .result-image img {
            width: 100%;
            height: 220px;
            object-fit: cover;
        }

        .result-title {
            font-size: 26px;
            font-weight: 800;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-list {
            display: grid;
            gap: 8px;
            font-size: 15px;
        }

        .summary-box {
            background: #fff;
            border-radius: 20px;
            padding: 18px;
            border: 1px solid var(--border);
            font-size: 15px;
            color: #443a33;
        }

        .confidence {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            border-radius: 999px;
            background: #f0e1cf;
            margin-top: 6px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 999px;
            background: #1f1c17;
            transition: width 0.4s ease;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 18px;
        }

        .history-card {
            display: flex;
            gap: 12px;
            background: white;
            border-radius: 18px;
            padding: 12px;
            border: 1px solid var(--border);
            align-items: center;
        }

        .history-thumb {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            overflow: hidden;
            background: #efe0ca;
            flex-shrink: 0;
        }

        .history-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .history-info {
            flex: 1;
        }

        .history-title {
            font-weight: 700;
            font-size: 15px;
        }

        .history-meta {
            font-size: 13px;
            color: #7f736a;
        }

        .history-price {
            font-weight: 800;
                font-size: 16px;
        }

        .chart-card {
            padding: 18px;
            border-radius: 22px;
            background: white;
            border: 1px solid var(--border);
        }

        .bar-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .bar {
            height: 12px;
            border-radius: 999px;
            background: #f1dcc5;
            flex: 1;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: 999px;
        }

        .pie {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            margin: 0 auto 12px;
        }

        .pie-legend {
            display: grid;
            gap: 6px;
            font-size: 13px;
        }

        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 520px;
            margin: 0 auto;
            background: var(--nav-bg);
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            padding: 12px 10px 22px;
            box-shadow: 0 -12px 30px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-around;
        }

        .nav-btn {
            text-decoration: none;
            color: #8c8176;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 13px;
            gap: 4px;
            padding: 8px 10px;
            border-radius: 16px;
        }

        .nav-btn.active {
            background: white;
            color: #1f1c17;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }

        .page-title {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #8f8478;
            font-size: 15px;
        }

        .analyzing-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.92);
            border-radius: 28px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
            font-weight: 700;
        }

        .spinner {
            width: 42px;
            height: 42px;
            border: 4px solid #f0e5d6;
            border-top-color: #1f1c17;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 400px) {
            header {
                padding: 24px 16px 6px;
            }
            header h1 {
                font-size: 24px;
            }
            .page-content {
                padding: 0 14px 105px;
            }
            .panel {
                padding: 18px;
                border-radius: 20px;
            }
            .camera-card {
                padding: 14px;
                border-radius: 22px;
            }
            .circle-btn {
                width: 60px;
                height: 60px;
            }
            .secondary-btn {
                width: 46px;
                height: 46px;
            }
            .result-title {
                font-size: 22px;
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
            .star-row {
                flex-direction: column;
            }
            .primary-btn,
            .ghost-btn {
                font-size: 15px;
                padding: 14px;
            }
            nav {
                border-top-left-radius: 24px;
                border-top-right-radius: 24px;
                padding-bottom: 18px;
            }
        }

        @media (min-width: 600px) {
            header {
                padding-top: 48px;
            }
            .page-content {
                padding-bottom: 130px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="module">
        import React from "https://esm.sh/react@18.2.0";
        import { createRoot } from "https://esm.sh/react-dom@18.2.0/client?deps=react@18.2.0";
        import {
            HashRouter,
            Routes,
            Route,
            Navigate,
            Link,
            useNavigate,
            useLocation
        } from "https://esm.sh/react-router-dom@6.22.2?deps=react@18.2.0";

        const { useState, useEffect, useMemo } = React;
        const h = React.createElement;

        const produceOptions = [
            { value: "banana", label: "Banana", icon: "ðŸŒ" },
            { value: "apple", label: "Apple", icon: "ðŸŽ" },
            { value: "avocado", label: "Avocado", icon: "ðŸ¥‘" },
            { value: "tomato", label: "Tomato", icon: "ðŸ…" },
            { value: "orange", label: "Orange", icon: "ðŸŠ" },
            { value: "strawberry", label: "Strawberry", icon: "ðŸ“" },
            { value: "mango", label: "Mango", icon: "ðŸ¥­" }
        ];

        const defaultImage = "https://images.unsplash.com/photo-1459411552884-841db9b3cc2a?auto=format&fit=crop&w=600&q=60";

        const navItems = [
            { path: "/home", label: "Home", icon: "ðŸ " },
            { path: "/scan", label: "Scan", icon: "ðŸ“·" },
            { path: "/history", label: "History", icon: "ðŸ•“" },
            { path: "/dashboard", label: "Dashboard", icon: "ðŸ“Š" },
            { path: "/settings", label: "Settings", icon: "âš™ï¸" }
        ];

        const discountPalette = {
            0: { badge: "green", color: "var(--discount-green)", label: "Peak Ripeness - Full Price" },
            10: { badge: "light", color: "var(--discount-light)", label: "Just Ripe - 10% Off" },
            30: { badge: "orange", color: "var(--discount-orange)", label: "Sell Today - 30% Off" },
            50: { badge: "red", color: "var(--discount-red)", label: "Past Peak - 50% Off" }
        };

        const weightedStar = () => {
            const weights = [0.05, 0.1, 0.2, 0.35, 0.3];
            const r = Math.random();
            let acc = 0;
            for (let i = 0; i < weights.length; i += 1) {
                acc += weights[i];
                if (r <= acc) return i + 1;
            }
            return 5;
        };

        const shelfLifeFromStars = (avg) => {
            if (avg >= 4.5) return "5-7 days";
            if (avg >= 3.5) return "3-4 days";
            if (avg >= 2.5) return "1-2 days";
            return "Sell today";
        };

        const discountFromStars = (avg) => {
            if (avg >= 4.5) return { discount: 0, label: "Peak Ripeness - Full Price", badge: "green" };
            if (avg >= 3.5) return { discount: 10, label: "Just Ripe - 10% Off", badge: "light" };
            if (avg >= 2.5) return { discount: 30, label: "Sell Today - 30% Off", badge: "orange" };
            return { discount: 50, label: "Past Peak - 50% Off", badge: "red" };
        };

        const summaryCopy = (produce, shelfLife, recommendation, defects) =>
            `Team, this ${produce.label.toLowerCase()} is trending ${recommendation.label.toLowerCase()}. Shelf life estimates ${shelfLife}, with ${defects.includes("No") ? "no visible defects" : "minor surface blemishes"} noted. Consider ${recommendation.label.toLowerCase()} to keep shrink low.`;

        const StarRating = ({ value }) => {
            const full = "â˜…".repeat(value);
            const empty = "â˜†".repeat(5 - value);
            return h("span", { className: "stars", "aria-label": `${value} star rating` }, full + empty);
        };

        const ConfidenceBar = ({ value }) =>
            h("div", null,
                h("div", { className: "confidence" },
                    h("span", null, "Confidence"),
                    h("span", null, `${value}%`)
                ),
                h("div", { className: "confidence-bar" },
                    h("div", { className: "confidence-fill", style: { width: `${value}%` } })
                )
            );

        const BottomNav = () => {
            const location = useLocation();
            return h("nav", null,
                navItems.map((item, idx) =>
                    h(Link, {
                        key: `${item.path}-${idx}`,
                        to: item.path,
                        className: `nav-btn ${location.pathname === item.path ? "active" : ""}`
                    }, h("span", { style: { fontSize: "18px" } }, item.icon), item.label)
                )
            );
        };

        const ScanPage = ({ onComplete }) => {
            const [produce, setProduce] = useState(produceOptions[0].value);
            const [price, setPrice] = useState("");
            const [imageData, setImageData] = useState(defaultImage);
            const [fileName, setFileName] = useState("Sample image");
            const [analyzing, setAnalyzing] = useState(false);
            const [error, setError] = useState("");
            const navigate = useNavigate();

            const handleImageChange = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    setImageData(event.target?.result || defaultImage);
                    setFileName(file.name);
            };
            reader.readAsDataURL(file);
            };

            const runAnalysis = () => {
                const selected = produceOptions.find((opt) => opt.value === produce);
                if (!selected) {
                    setError("Choose a produce item before scanning.");
                    return;
                }
                setError("");
                setAnalyzing(true);

                const delay = 1100 + Math.random() * 800;
            setTimeout(() => {
                    const ripeness = weightedStar();
                    const freshness = weightedStar();
                    const avgStars = (ripeness + freshness) / 2;
                    const defects = Math.random() < 0.9 ? "No defects! ðŸ‘" : "Minor defects detected âš ï¸";
                    const shelfLife = shelfLifeFromStars(avgStars);
                    const recommendation = discountFromStars(avgStars);
                    const confidence = Math.floor(Math.random() * 10) + 89;
                    const originalPrice = parseFloat(price) || 0;
                    const newPrice = originalPrice ? originalPrice * (1 - recommendation.discount / 100) : 0;
                    const analysis = {
                        id: Date.now(),
                        produce: selected,
                        ripeness,
                        freshness,
                        defects,
                        shelfLife,
                        recommendation,
                        confidence,
                        originalPrice,
                        newPrice,
                        imageData,
                        fileName,
                        timestamp: new Date().toLocaleString(),
                        summary: summaryCopy(selected, shelfLife, recommendation, defects)
                    };
                    onComplete(analysis);
                    setAnalyzing(false);
                    navigate("/results");
                }, delay);
            };

            return h("div", { className: "grid", style: { gap: "20px" } },
                h("div", { className: "panel grid" },
                    h("div", null,
                        h("label", { htmlFor: "produce-select" }, "Produce Type"),
                        h("select", {
                            id: "produce-select",
                            value: produce,
                            onChange: (e) => setProduce(e.target.value)
                        }, produceOptions.map((opt) =>
                            h("option", { key: opt.value, value: opt.value }, `${opt.icon} ${opt.label}`)
                        ))
                    ),
                    h("div", null,
                        h("label", { htmlFor: "price-input" }, "Original Price ($)"),
                        h("input", {
                            id: "price-input",
                            type: "number",
                            min: 0,
                            step: 0.01,
                            placeholder: "Enter price per item",
                            value: price,
                            onChange: (e) => setPrice(e.target.value)
                        })
                    ),
                    h("div", { className: "camera-card" },
                        h("div", { className: "camera-preview" },
                            h("img", { src: imageData, alt: "Produce preview" })
                        ),
                        h("div", { className: "camera-controls" },
                            h("label", { className: "secondary-btn", title: "Upload image" },
                                h("input", {
                                    type: "file",
                                    accept: "image/*",
                                    style: { display: "none" },
                                    onChange: handleImageChange
                                }),
                                "â¬†ï¸"
                            ),
                            h("button", {
                                className: "circle-btn",
                                onClick: runAnalysis,
                                "aria-label": "Capture or upload"
                            }, "â—")
                        ),
                        analyzing && h("div", { className: "analyzing-overlay" },
                            h("div", { className: "spinner" }),
                            "Analyzing..."
                        )
                    ),
                    error && h("div", { style: { color: "#b33a3a", fontWeight: 600 } }, error),
                    h("button", { className: "primary-btn", onClick: runAnalysis }, "Capture & Analyze"),
                    h("button", { className: "ghost-btn", onClick: () => setImageData(defaultImage) }, "Reset Preview")
                )
            );
        };

        const ResultsPage = ({ result, onRescan, onPriceUpdate }) => {
            const [price, setPrice] = useState(result?.originalPrice ?? 0);
            useEffect(() => {
                if (result) setPrice(result.originalPrice ?? 0);
            }, [result]);

            if (!result) {
                return h("div", { className: "empty-state" }, "Run a scan to view results.");
            }

            const newPrice = price ? (price * (1 - result.recommendation.discount / 100)).toFixed(2) : "0.00";
            const badgeClass = `badge ${result.recommendation.badge}`;
            return h("div", { className: "grid", style: { gap: "20px" } },
                h("div", { className: "result-hero" },
                    h("div", { className: "result-image" },
                        h("img", { src: result.imageData, alt: `${result.produce.label} scan` })
                    ),
                    h("div", { className: "result-title" },
                        `${result.produce.icon} ${result.produce.label}`,
                        h("span", { className: badgeClass }, result.recommendation.label)
                    ),
                    h("div", { className: "star-row", style: { display: "flex", gap: "12px" } },
                        h("div", { className: "analysis-card", style: { flex: 1 } },
                            h("h3", null, "Ripeness"),
                            h(StarRating, { value: result.ripeness })
                        ),
                        h("div", { className: "analysis-card", style: { flex: 1 } },
                            h("h3", null, "Freshness"),
                            h(StarRating, { value: result.freshness })
                        )
                    ),
                    h("div", { className: "stat-list" },
                        h("div", null, `Defect Detection: ${result.defects}`),
                        h("div", null, `Estimated Shelf Life: ${result.shelfLife}`),
                        h("div", null, `Recommended Action: ${result.recommendation.label}`)
                    ),
                    h("div", { className: "analysis-card" },
                        h("label", { htmlFor: "result-price" }, "Original Price ($)"),
                        h("input", {
                            id: "result-price",
                            type: "number",
                            min: 0,
                            step: 0.01,
                            value: price ? price.toString() : "",
                            onChange: (e) => {
                                const val = parseFloat(e.target.value) || 0;
                                setPrice(val);
                                onPriceUpdate(val);
                            }
                        }),
                        h("div", { style: { marginTop: "12px", fontWeight: 700 } }, `Recommended Discount: ${result.recommendation.discount}%`),
                        h("div", { style: { fontSize: "30px", marginTop: "6px", fontWeight: 800 } }, `New Price: $${newPrice}`)
                    ),
                    h("div", { className: "summary-box" }, result.summary),
                    h(ConfidenceBar, { value: result.confidence })
                ),
                h("div", { className: "grid", style: { gap: "12px" } },
                    h("button", { className: "primary-btn", style: { background: "#3bb273" }, onClick: () => alert("Discount applied to store system.") }, "Apply Discount"),
                    h("button", { className: "ghost-btn", onClick: onRescan }, "Scan Another Item")
                )
            );
        };

        const HistoryPage = ({ history, onClear }) => {
            const [query, setQuery] = useState("");
            const filtered = history.filter((entry) => entry.produce.label.toLowerCase().includes(query.toLowerCase()));
            return h("div", null,
                h("div", { className: "page-title" }, "Recent Scans"),
                h("div", { className: "analysis-card" },
                    h("label", { htmlFor: "history-search" }, "Search by produce"),
                    h("input", {
                        id: "history-search",
                        placeholder: "e.g. Avocado",
                        value: query,
                        onChange: (e) => setQuery(e.target.value)
                    }),
                    h("button", { className: "ghost-btn", style: { marginTop: "10px" }, onClick: onClear }, "Clear All History")
                ),
                filtered.length === 0 ? h("div", { className: "empty-state" }, "No scans yet.") :
                    h("div", { className: "history-list" },
                        filtered.map((entry) =>
                            h("div", { key: entry.id, className: "history-card" },
                                h("div", { className: "history-thumb" },
                                    h("img", { src: entry.imageData, alt: entry.produce.label })
                                ),
                                h("div", { className: "history-info" },
                                    h("div", { className: "history-title" }, `${entry.produce.icon} ${entry.produce.label}`),
                                    h("div", { className: "history-meta" },
                                        `${entry.timestamp} â€¢ ${entry.recommendation.discount}% off â€¢ ${entry.shelfLife}`
                                    )
                                ),
                                h("div", { className: "history-price" },
                                    entry.originalPrice ? `$${(entry.originalPrice * (1 - entry.recommendation.discount / 100)).toFixed(2)}` : "N/A"
                                )
                            )
                        )
                    )
            );
        };

        const DashboardPage = ({ history }) => {
            const totals = useMemo(() => {
                const totalScans = history.length;
                const discountValue = history.reduce((acc, entry) => {
                    if (!entry.originalPrice) return acc;
                    return acc + entry.originalPrice * (entry.recommendation.discount / 100);
                }, 0);
                const avgDiscount = totalScans ? history.reduce((acc, entry) => acc + entry.recommendation.discount, 0) / totalScans : 0;
                const itemsFull = history.filter((entry) => entry.recommendation.discount === 0).length;
                const discountBuckets = { 0: 0, 10: 0, 30: 0, 50: 0 };
                history.forEach((entry) => {
                    discountBuckets[entry.recommendation.discount] += 1;
                });
                const produceCounts = history.reduce((acc, entry) => {
                    acc[entry.produce.label] = (acc[entry.produce.label] || 0) + 1;
                    return acc;
                }, {});
                return {
                    totalScans,
                    discountValue,
                    avgDiscount,
                    itemsFull,
                    itemsDiscounted: totalScans - itemsFull,
                    discountBuckets,
                    produceCounts
                };
            }, [history]);

            const pieGradient = useMemo(() => {
                const entries = Object.entries(totals.produceCounts);
                if (!entries.length) return "conic-gradient(#f0d9bd 0deg 360deg)";
                const total = entries.reduce((acc, [, count]) => acc + count, 0);
                let current = 0;
                const segments = entries.map(([, count], idx) => {
                    const colors = ["#f8c26a", "#f49d6e", "#f06f6f", "#c6e39a", "#92d8d8", "#f7e58b", "#c3aed6"];
                    const angle = (count / total) * 360;
                    const start = current;
                    const end = current + angle;
                    current = end;
                    return `${colors[idx % colors.length]} ${start}deg ${end}deg`;
                }).join(", ");
                return `conic-gradient(${segments})`;
            }, [totals.produceCounts]);

            return h("div", { className: "grid", style: { gap: "18px" } },
                h("div", { className: "page-title" }, "Today's Performance"),
                h("div", { className: "grid", style: { gap: "12px" } },
                    [
                        { label: "Total Scans", value: totals.totalScans || 0 },
                        { label: "Total Discount Value", value: `$${totals.discountValue.toFixed(2)}` },
                        { label: "Avg Discount", value: `${totals.avgDiscount.toFixed(0)}%` },
                        { label: "Items at Full Price", value: totals.itemsFull },
                        { label: "Items Discounted", value: totals.itemsDiscounted },
                        { label: "Estimated waste prevented", value: totals.totalScans ? "12 lbs" : "0 lbs" },
                        { label: "Revenue recovered", value: totals.totalScans ? "$87.30" : "$0.00" }
                    ].map((stat) =>
                        h("div", { key: stat.label, className: "analysis-card" },
                            h("div", { style: { fontSize: "12px", color: "#9a8d81", textTransform: "uppercase" } }, stat.label),
                            h("div", { style: { fontSize: "24px", fontWeight: 800 } }, stat.value)
                        )
                    )
                ),
                h("div", { className: "chart-card" },
                    h("h3", { style: { marginBottom: "12px" } }, "Discount Distribution"),
                    Object.entries(totals.discountBuckets).map(([percent, count]) => {
                        const fillPercent = totals.totalScans ? (count / totals.totalScans) * 100 : 0;
                        const palette = discountPalette[percent] || { color: "#ebd9c9" };
                        return h("div", { key: percent, className: "bar-row" },
                            h("span", { style: { width: "60px", fontSize: "14px" } }, `${percent}%`),
                            h("div", { className: "bar" },
                                h("div", { className: "bar-fill", style: { width: `${fillPercent}%`, background: palette.color } })
                            ),
                            h("span", { style: { fontWeight: 700 } }, count)
                        );
                    })
                ),
                h("div", { className: "chart-card" },
                    h("h3", { style: { marginBottom: "12px" } }, "Produce Mix"),
                    h("div", { className: "pie", style: { background: pieGradient } }),
                    h("div", { className: "pie-legend" },
                        Object.entries(totals.produceCounts).map(([label, count]) =>
                            h("div", { key: label }, `${label}: ${count}`)
                        )
                    )
                )
            );
        };

        const SettingsPage = () =>
            h("div", { className: "grid", style: { gap: "16px" } },
                h("div", { className: "page-title" }, "How to Use"),
                h("div", { className: "analysis-card" },
                    h("ol", { style: { paddingLeft: "18px", lineHeight: 1.6 } },
                        h("li", null, "Select produce type & enter original price."),
                        h("li", null, "Capture or upload a clear photo."),
                        h("li", null, "Review automated assessment & pricing recommendation."),
                        h("li", null, "Apply discount to sync with in-store labels.")
                    )
                ),
                h("div", { className: "analysis-card" },
                    h("h3", null, "Freshness Rating Guide"),
                    ["5 stars = Peak Ripeness â†’ Full Price", "4 stars = Just Ripe â†’ 10% off", "3 stars = Sell Today â†’ 30% off", "1-2 stars = Past Peak â†’ 50% off"].map((item) =>
                        h("div", { key: item }, item)
                    )
                ),
                h("div", { className: "analysis-card" },
                    h("h3", null, "Store Information"),
                    h("p", null, "Store #4523"),
                    h("p", null, "Produce Department"),
                    h("p", null, "Contact: produce.manager@groceryco.com")
                ),
                h("div", { className: "analysis-card" },
                    h("h3", null, "About"),
                    h("p", null, "Prototype tool demonstrating freshness insights, pricing guidance, and waste reduction for grocery teams. No real computer vision is performed.")
                )
            );

        const App = () => {
            const [history, setHistory] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem("produce-history")) || [];
                } catch {
                    return [];
                }
            });
            const [result, setResult] = useState(null);

            useEffect(() => {
                localStorage.setItem("produce-history", JSON.stringify(history));
            }, [history]);

            const handleScanComplete = (analysis) => {
                setResult(analysis);
                setHistory((prev) => [analysis, ...prev].slice(0, 15));
            };

            const clearHistory = () => {
                if (confirm("Clear all scan history?")) {
                    setHistory([]);
                }
            };

            const ScanRoute = () => h(ScanPage, { onComplete: handleScanComplete });

            const ResultsRoute = () => {
                const navigate = useNavigate();
                return h(ResultsPage, {
                    result,
                    onRescan: () => navigate("/scan"),
                    onPriceUpdate: (value) => setResult((prev) => prev ? { ...prev, originalPrice: value, newPrice: value * (1 - (prev.recommendation.discount / 100)) } : prev)
                });
            };

            const HistoryRoute = () => h(HistoryPage, { history, onClear: clearHistory });
            const DashboardRoute = () => h(DashboardPage, { history });
            const SettingsRoute = () => h(SettingsPage);

            return h(HashRouter, null,
                h("div", { className: "app-shell" },
                    h("header", null,
                        h("span", null, "PRODUCE OPS"),
                        h("h1", null, "Produce Scanner")
                    ),
                    h("main", { className: "page-content" },
                        h(Routes, null,
                            h(Route, { path: "/", element: h(Navigate, { to: "/home", replace: true }) }),
                            h(Route, { path: "/home", element: h(ScanRoute) }),
                            h(Route, { path: "/scan", element: h(ScanRoute) }),
                            h(Route, { path: "/results", element: h(ResultsRoute) }),
                            h(Route, { path: "/history", element: h(HistoryRoute) }),
                            h(Route, { path: "/dashboard", element: h(DashboardRoute) }),
                            h(Route, { path: "/settings", element: h(SettingsRoute) })
                        )
                    ),
                    h(BottomNav, null)
                )
            );
        };

        const root = createRoot(document.getElementById("root"));
        root.render(h(App, null));
    </script>
</body>
</html>

